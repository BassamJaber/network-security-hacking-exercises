#!/usr/bin/env python3
import socket
from binascii import hexlify, unhexlify



def main():
    # create socket and connect to bob
    HOST = 'netsec.net.in.tum.de'
    PORT = 20009
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

    # Our protocol is line-based. Each message should end with an '\n'. Otherwise, it may result in errors!
    # If your script is stuck (i.e the buffer is not flushed), you probably forgot the newline.

    s.connect((HOST, PORT))
    sf = s.makefile("rw")  # we use a file abstraction for the sockets

    msg = "no pdf!"
    msg =""
    sig=0
    # sig = 163500588565413589352223629993702135739553077726756675440483306149798655204198344843331760510195175146814283361544599092537829135392507095081189793305633877579801872353570978891656895873906720972156496510294340234516526820409601201157470113610776283535313672719914216998384589074577810712618749784654963164457298206679206106288451467218119111005586799354808981113680264987046206060750257686647037454085439353822993257283049011391575445877432910796187683784616135184038509000623975847726989176467768485894080202764047363760247366252679311291290712778367908272395456305424135780083973483881490048487013709681486797990575776687556570657434895936063064352824902751797801367588761683002308814083687035474716660147561280405061360257233050146356452363141796331668985248692662663373288645919871965565565752700763707034371541411984117066914044048705284982729782635634074397342268292712457694540587289705144940586268178864341401905889979409923989232901952003847076681021756685359762635857287343475290926048910152860823823992991796090710432322569811067679084747310572870435102855208492631791174093531156354615739783278886214373856469832863381039009300322074397167027094058668629821721593192632219014070329502647086443400117444386018037360999824
    sf.write("{},{}\n".format(msg, sig))
    sf.flush()
    
    
    data = sf.readline()
    print("From Bob: `{}'".format(data))

    data = sf.readline()
    if len(data) < 1024:
        print("From Bob: `{}'".format(data))
    else:
        print("received {} bytes".format(len(data)))


    data = data.rstrip('\n') # remove trailing newline
    
    
    if ',' in data:
        data = data.split(",")
        assert len(data) == 2
        iv, data = data
        print("Encrypted data, cannot continue")
        return
    
    data = unhexlify(data)
    pdf_hdr = b'%PDF-1.5'
    if len(data) >= len(pdf_hdr) and data[:len(pdf_hdr)] == pdf_hdr:
        print("Looks like we got a PDF!")
        with open('data_recieved.pdf', mode='wb') as f:
            f.write(data)
    sf.close()
    s.close()


main()

